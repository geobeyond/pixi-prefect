---
- name: Deploy common tools to all nodes
  hosts: all
  become: yes
  tags: 
    - "prefect-server"
    - "prefect-worker"

  tasks:

    - name: Check if ACL is installed
      command: dpkg -l acl
      register: acl_status
      changed_when: false
      failed_when: false

    - name: Install ACL package
      when: acl_status.rc != 0
      block:
        - name: Ensure ACL packages directory exists
          file:
            path: "/tmp/offline-packages/acl"
            state: directory
            mode: "0755"

        - name: Copy acl .deb packages to server
          copy:
            src: "{{ item }}"
            dest: "/tmp/offline-packages/acl/"
            mode: "0644"
          with_fileglob:
            - "../offline-packages/acl/*.deb"

        - name: Install acl packages
          shell: "dpkg --install /tmp/offline-packages/acl/*.deb || apt install --yes --fix-broken --allow-downgrades /tmp/offline-packages/acl/*.deb"
          register: dpkg_result
          failed_when: dpkg_result.rc != 0 and "already installed" not in dpkg_result.stderr

        - name: Clean up temporary acl .deb files
          file:
            path: "/tmp/offline-packages/acl"
            state: absent

    - name: Check if rsync is installed
      command: dpkg -l rsync
      register: rsync_status
      changed_when: false
      failed_when: false

    - name: Install rsync package
      when: rsync_status.rc != 0
      block:
        - name: Ensure rsync packages directory exists
          file:
            path: "/tmp/offline-packages/rsync"
            state: directory
            mode: "0755"

        - name: Copy rsync .deb packages to server
          copy:
            src: "{{ item }}"
            dest: "/tmp/offline-packages/rsync/"
            mode: "0644"
          with_fileglob:
            - "../offline-packages/rsync/*.deb"

        - name: Install rsync packages
          shell: "dpkg --install /tmp/offline-packages/rsync/*.deb || apt install --yes --fix-broken --allow-downgrades /tmp/offline-packages/rsync/*.deb"
          register: dpkg_result
          failed_when: dpkg_result.rc != 0 and "already installed" not in dpkg_result.stderr

        - name: Clean up temporary rsync .deb files
          file:
            path: "/tmp/offline-packages/rsync"
            state: absent

    - name: Check if prefect user exists
      command: getent passwd prefect
      register: prefect_user_check
      changed_when: false
      failed_when: false


    - name: Create prefect user
      when: prefect_user_check.rc != 0
      user:
        name: prefect
        system: yes
        shell: /bin/bash
        home: /opt/prefect
        create_home: yes

    - name: Copy pixi binary to node
      copy:
        src: "../pixi"
        dest: "/usr/local/bin/pixi"
        mode: "0755"
        owner: root
        group: root

    - name: Copy pixi-unpack binary to node
      copy:
        src: "../pixi-unpack"
        dest: "/usr/local/bin/pixi-unpack"
        mode: "0755"
        owner: root
        group: root

    - name: Copy pixi base pack
      copy:
        src: "../prefect-base.tar"
        dest: "/opt/prefect/prefect-base.tar"
        owner: prefect
        group: prefect
        mode: "0644"

    - name: Unpack pixi environment
      become_user: prefect
      shell: pixi-unpack --output-directory /opt/prefect/pixi-env /opt/prefect/prefect-base.tar
      args:
        creates: /opt/prefect/pixi-env

    - name: Remove pixi pack file
      file:
        path: "/opt/prefect/prefect-base.tar"
        state: absent