---
- name: Deploy Prefect worker with pixi
  hosts: prefect_workers
  become: yes
  tags: 
    - "prefect-worker"
  vars:
    prefect_server_ip: "{{ groups['prefect_servers'][0] }}"
    basic_auth_key: "{{ hostvars['localhost']['prefect_basic_auth_key'] | default(lookup('env', 'PREFECT_BASIC_AUTH_KEY')) }}"

  tasks:
    - name: Set default values for inventory-related variables
      set_fact:
        enable_gpu_worker: "{{ enable_gpu_worker | default(false) }}"
        enable_cpu_worker: "{{ enable_cpu_worker | default(true) }}"
        cpu_worker_limit: "{{ cpu_worker_limit | default(16) }}"

    - name: Create flows directory
      file:
        path: "/opt/prefect/flows"
        state: directory
        owner: prefect
        group: prefect
        mode: "0755"

    - name: Validate worker configuration
      assert:
        that:
          - enable_gpu_worker or enable_cpu_worker
        fail_msg: "At least one worker type must be enabled (GPU or CPU)"
        success_msg: "Worker configuration valid"

    - name: Check if worker has GPUs configured
      set_fact:
        has_gpus: "{{ worker_gpu_ids is defined and worker_gpu_ids | length > 0 }}"

    - name: Validate GPU worker configuration
      assert:
        that:
          - has_gpus
        fail_msg: "GPU worker enabled but no worker_gpu_ids defined"
      when: enable_gpu_worker

    - name: Calculate GPU worker limit from GPU count
      set_fact:
        gpu_worker_limit: "{{ worker_gpu_ids.split(',') | length }}"
      when: enable_gpu_worker and has_gpus

    - name: Display worker configuration
      debug:
        msg: |
          Configuring worker {{ inventory_hostname }}:
            - GPU IDs: {{ worker_gpu_ids | default('none') }}
            - GPU Worker: {{ enable_gpu_worker }} (limit: {{ gpu_worker_limit if enable_gpu_worker else 'N/A' }})
            - CPU Worker: {{ enable_cpu_worker }} (limit: {{ cpu_worker_limit if enable_cpu_worker else 'N/A' }})

    - name: Create Prefect GPU worker systemd unit
      template:
        src: "templates/prefect-worker-gpu.service.j2"
        dest: "/etc/systemd/system/prefect-worker-gpu.service"
        mode: "0644"
      when: enable_gpu_worker
      notify:
        - reload systemd
        - restart prefect gpu worker

    - name: Create Prefect CPU worker systemd unit
      template:
        src: "templates/prefect-worker-cpu.service.j2"
        dest: "/etc/systemd/system/prefect-worker-cpu.service"
        mode: "0644"
      when: enable_cpu_worker
      notify:
        - reload systemd
        - restart prefect cpu worker

    - name: Start and enable Prefect GPU worker
      systemd:
        name: prefect-worker-gpu
        state: started
        enabled: yes
        daemon_reload: yes
      when: enable_gpu_worker

    - name: Start and enable Prefect CPU worker
      systemd:
        name: prefect-worker-cpu
        state: started
        enabled: yes
        daemon_reload: yes
      when: enable_cpu_worker

    - name: Build list of namespaced GPU identifiers
      set_fact:
        all_gpu_limits: >-
          {%- set gpu_list = [] -%}
          {%- for host in groups['prefect_workers'] -%}
            {%- if hostvars[host].worker_gpu_ids is defined and hostvars[host].worker_gpu_ids | length > 0 -%}
              {%- for gpu_id in hostvars[host].worker_gpu_ids.split(',') -%}
                {%- set _ = gpu_list.append('gpu-' ~ host ~ '-' ~ gpu_id | trim) -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ gpu_list }}
      run_once: true
      delegate_to: localhost

    - name: Display GPU concurrency limits to be created
      debug:
        msg: "GPU concurrency limits to create/verify: {{ all_gpu_limits if all_gpu_limits | length > 0 else 'none - no GPU workers in cluster' }}"
      run_once: true

    - name: Wait for Prefect server to be ready
      wait_for:
        port: 4200
        host: "{{ prefect_server_ip }}"
        delay: 5
        timeout: 60
      run_once: true
      delegate_to: localhost
      when: all_gpu_limits | length > 0

    - name: Create concurrency limit for each namespaced GPU
      become: yes
      become_user: prefect
      loop: "{{ all_gpu_limits }}"
      shell: >
        cd /opt/prefect && 
        pixi-env/env/bin/prefect global-concurrency-limit create {{ item }} --limit 1
      environment:
        PREFECT_API_URL: "http://{{ prefect_server_ip }}:4200/api"
        HOME: /opt/prefect
      register: concurrency_result
      # Ignore errors if limit already exists
      failed_when:
        - concurrency_result.rc != 0
        - "'already exists' not in concurrency_result.stderr"
        - "'already exists' not in concurrency_result.stdout"
      ignore_errors: yes
      run_once: true
      delegate_to: "{{ prefect_server_ip }}"
      when: all_gpu_limits | length > 0

    - name: Display concurrency limit creation results
      debug:
        msg: "Created/verified {{ all_gpu_limits | length }} GPU concurrency limits"
      run_once: true
      when: all_gpu_limits | length > 0

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart prefect gpu worker
      systemd:
        name: prefect-worker-gpu
        state: restarted

    - name: restart prefect cpu worker
      systemd:
        name: prefect-worker-cpu
        state: restarted
