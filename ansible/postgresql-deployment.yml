---
- name: Deploy PostgreSQL Database
  hosts: prefect_servers
  become: yes
  tags: 
    - "prefect-server"
  vars:
    postgresql_version: "17"
    postgresql_db_name: "prefect"
    postgresql_user: "prefect"
    postgresql_password: "{{ hostvars['localhost']['postgresql_password'] | default(lookup('env', 'POSTGRESQL_PASSWORD')) }}"

  tasks:
    - name: Check if PostgreSQL is running
      systemd:
        name: postgresql
      register: postgresql_status
      ignore_errors: yes

    - name: Install libldap dependency
      when: postgresql_status is undefined or postgresql_status.status.ActiveState != "active"
      block:
        - name: Create temporary directory for libldap packages
          file:
            path: "/tmp/offline-packages/libldap"
            state: directory
            mode: "0755"

        - name: Copy libldap .deb packages to server
          copy:
            src: "{{ item }}"
            dest: "/tmp/offline-packages/libldap"
            mode: "0644"
          with_fileglob:
            - "../offline-packages/libldap-2.5-0/*.deb"

        - name: Install libldap packages with dpkg
          shell: "dpkg --install /tmp/offline-packages/libldap/*.deb || apt install --yes --fix-broken --allow-downgrades /tmp/offline-packages/libldap/*.deb"
          environment:
            DEBIAN_FRONTEND: noninteractive

        - name: Clean up temporary libldap .deb files
          file:
            path: "/tmp/offline-packages/libldap"
            state: absent

    - name: Install PostgreSQL
      when: postgresql_status is undefined or postgresql_status.status.ActiveState != "active"
      block:
        - name: Create temporary directory for PostgreSQL packages
          file:
            path: "/tmp/offline-packages/postgresql"
            state: directory
            mode: "0755"

        - name: Copy PostgreSQL .deb packages to server
          copy:
            src: "{{ item }}"
            dest: "/tmp/offline-packages/postgresql"
            mode: "0644"
          with_fileglob:
            - "../offline-packages/postgresql-{{ postgresql_version }}/*.deb"

        - name: Install PostgreSQL packages with dpkg
          shell: "dpkg --install /tmp/offline-packages/postgresql/*.deb || apt install --yes --fix-broken --allow-downgrades /tmp/offline-packages/postgresql/*.deb"
          environment:
            DEBIAN_FRONTEND: noninteractive
          register: apt_result
          failed_when: apt_result.rc != 0
          notify: restart postgresql

        - name: Start and enable PostgreSQL
          systemd:
            name: postgresql
            state: started
            enabled: yes

        - name: Clean up temporary PostgreSQL .deb files
          file:
            path: "/tmp/offline-packages/postgresql"
            state: absent

    - name: Configure PostgreSQL database and user
      block:
        - name: Create PostgreSQL database
          become_user: postgres
          command: createdb {{ postgresql_db_name }}
          register: createdb_result
          failed_when: createdb_result.rc != 0 and "already exists" not in createdb_result.stderr

        - name: Create PostgreSQL DB user
          become_user: postgres
          command: psql -c "CREATE USER {{ postgresql_user }} WITH PASSWORD '{{ postgresql_password }}';"
          register: createuser_result
          failed_when: createuser_result.rc != 0 and "already exists" not in createuser_result.stderr

        - name: Grant privileges to DB user
          become_user: postgres
          command: psql -c "GRANT ALL PRIVILEGES ON DATABASE {{ postgresql_db_name }} TO {{ postgresql_user }};"

        - name: Grant schema privileges to DB user
          become_user: postgres
          command: psql -c "GRANT ALL PRIVILEGES ON SCHEMA public TO {{ postgresql_user }};" {{ postgresql_db_name }}

        - name: Configure PostgreSQL to allow local connections
          lineinfile:
            path: "/etc/postgresql/{{ postgresql_version }}/main/pg_hba.conf"
            line: "host    {{ postgresql_db_name }}    {{ postgresql_user }}    127.0.0.1/32    md5"
            insertafter: "# IPv4 local connections:"
          notify: restart postgresql

  handlers:
    - name: restart postgresql
      systemd:
        name: postgresql
        state: restarted