---
- name: Deploy Prefect Flow
  hosts: prefect_workers
  become: yes
  tags: 
    - "prefect-flow"
  vars:
    flow_root_dir: "{{ flow_dir }}"
    flow_entrypoint: "{{ entrypoint }}"
    flow_function_name: "{{ flow_entrypoint.split(':')[1] }}"
    flow_deployment_name: "{{ deployment_name | default(flow_function_name) }}"
    flow_target_dir: "/opt/prefect/flows/{{ flow_root_dir | basename }}"
    pixi_envs_dir: "{{ flow_target_dir}}/.pixi/envs"
    pixi_manifest_path: "{{ flow_target_dir }}/pixi.toml"
    pixi_run_command: "pixi run --no-lockfile-update --frozen"
    work_pool_name: "{{ work_pool | default('cpu-pool') }}"
    prefect_server_ip: "{{ groups['prefect_servers'][0] }}"
    # optional variables for the deployment of the flow
    deployment_schedule: "{{ schedule | default(None) }}"
    deployment_parameters: "{{ extra_parameters | default(None) }}"

  tasks:

    - name: Validate required variables
      assert:
        that:
          - flow_root_dir is defined
          - flow_entrypoint is defined
        fail_msg: "Required variables: flow_dir, entrypoint"
      run_once: true
      delegate_to: localhost

    - name: Check if flow directory exists
      stat:
        path: "{{ flow_root_dir }}"
      register: flow_dir_stat
      run_once: true
      delegate_to: localhost
      become: no

    - name: Display deployment configuration
      debug:
        msg: |
          Deploying flow:
            - Entrypoint: {{ flow_entrypoint }}
            - Deployment: {{ flow_deployment_name }}
            - Work Pool: {{ work_pool_name }}
            - Schedule: {{ deployment_schedule if deployment_schedule is not none else 'none' }}
            - Parameters: {{ deployment_parameters if deployment_parameters is not none else 'none' }}
            - Targets: {{ groups['prefect_workers'] | join(', ') }}
      run_once: true

    - name: Create temporary directory for flow packaging
      delegate_to: localhost
      run_once: true
      become: no
      tempfile:
        state: directory
      register: temp_dir

    - name: Pack flow dependencies with pixi
      delegate_to: localhost
      run_once: true
      become: no
      shell: "pixi pack {{ flow_root_dir }}/pixi.toml --output-file {{ temp_dir.path }}/flow-env.tar"

    - name: Create flow directory on target
      file:
        path: "{{ flow_target_dir }}"
        state: directory
        owner: prefect
        group: prefect
        mode: "0755"

    - name: Create pixi envs directory on target
      file:
        path: "{{ pixi_envs_dir }}"
        state: directory
        owner: prefect
        group: prefect
        mode: "0755"

    - name: Synchronize flow files to target
      ansible.posix.synchronize:
        src: "{{ flow_root_dir }}/"
        dest: "{{ flow_target_dir }}/"
        rsync_opts:
          - "--exclude=*.pixi/"
          - "--exclude=**/*.pyc"
          - "--exclude=**/__pycache__/"
          - "--exclude=prefect.yaml"
          - "--chown=prefect:prefect"
        delete: yes

    - name: Copy pixi pack to target
      copy:
        src: "{{ temp_dir.path }}/flow-env.tar"
        dest: "{{ flow_target_dir }}/flow-env.tar"
        owner: prefect
        group: prefect
        mode: "0644"

    - name: Unpack pixi environment
      become_user: prefect
      shell: pixi-unpack --env-name default --output-directory {{ pixi_envs_dir }} {{ flow_target_dir }}/flow-env.tar
      args:
        creates: "{{ pixi_envs_dir }}/env"

    - name: Create prefect.yaml from template
      template:
        src: templates/prefect-deployment.j2
        dest: "{{ flow_target_dir }}/prefect.yaml"
        owner: prefect
        group: prefect
        mode: "0644"

    - name: Deploy flow to prefect server
      run_once: true
      become_user: prefect
      shell: "{{ pixi_run_command }} prefect deploy"
      args:
        chdir: "{{ flow_target_dir }}"
      environment:
        PREFECT_API_URL: "http://{{ prefect_server_ip }}:4200/api"

    - name: Remove pixi pack file
      file:
        path: "{{ flow_target_dir }}/flow-env.tar"
        state: absent

    - name: Clean up temporary directory
      delegate_to: localhost
      run_once: true
      file:
        path: "{{ temp_dir.path }}"
        state: absent

    - name: Display deployment success
      debug:
        msg: |
          âœ… Flow deployed successfully!
            
          Deployment: {{ flow_deployment_name }}
          Work Pool: {{ work_pool_name }}
      run_once: true

